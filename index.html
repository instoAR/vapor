<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VAPORGRAM (pixel glitch cam)</title>
<style>
  :root{
    --bg-saved: none;
    --title1:#0b3ea8;
    --title2:#2b78d8;

    --win:#c0c0c0;
    --hi:#ffffff;
    --dk:#404040;

    --shadow: rgba(0,0,0,.28);
    --font: "MS Sans Serif", Tahoma, Arial, sans-serif;
    --frame:2px;
  }

  html,body{height:100%}
  body{
    margin:0;
    font-family: var(--font);
    overflow:hidden;
    background:#0e1020;
  }

  /* wallpaper layer (uses saved glitch image if present) */
  .bg{
    position:fixed; inset:0;
    background:
      linear-gradient(0deg, rgba(0,0,0,.55), rgba(0,0,0,.55)),
      var(--bg-saved),
      radial-gradient(circle at 70% 20%, rgba(255,89,199,.25), transparent 45%),
      radial-gradient(circle at 25% 70%, rgba(57,242,255,.20), transparent 50%),
      linear-gradient(135deg, #2a2a3a, #1b1c2b);
    background-size: cover;
    background-position:center;
    filter: saturate(1.08) contrast(1.04);
    transform: scale(1.02);
  }

  /* scanlines */
  .fx{
    position:fixed; inset:0;
    pointer-events:none;
    background: repeating-linear-gradient(to bottom, rgba(0,0,0,.10) 0 1px, transparent 1px 3px);
    opacity:.35;
    mix-blend-mode: soft-light;
  }

  .stage{
    position:relative;
    height:100%;
    display:grid;
    place-items:center;
    padding:18px;
  }

  .bevel-out{
    background: var(--win);
    border-top: var(--frame) solid var(--hi);
    border-left: var(--frame) solid var(--hi);
    border-right: var(--frame) solid var(--dk);
    border-bottom: var(--frame) solid var(--dk);
    box-shadow: 10px 10px 0 var(--shadow);
  }
  .bevel-in{
    background: #fff;
    border-top: var(--frame) solid var(--dk);
    border-left: var(--frame) solid var(--dk);
    border-right: var(--frame) solid var(--hi);
    border-bottom: var(--frame) solid var(--hi);
  }

  .screen{
    position:absolute; inset:0;
    display:grid;
    place-items:center;
    opacity:0;
    pointer-events:none;
    transition: opacity .22s linear;
  }
  .screen.active{
    opacity:1;
    pointer-events:auto;
  }

  .transition{
    position:fixed; inset:0;
    pointer-events:none;
    opacity:0;
    background:
      repeating-linear-gradient(90deg, rgba(255,89,199,.12) 0 3px, transparent 3px 7px),
      repeating-linear-gradient(0deg, rgba(57,242,255,.10) 0 2px, transparent 2px 5px);
    mix-blend-mode: screen;
  }
  .transition.on{ animation: trans .42s ease-out forwards; }
  @keyframes trans{
    0%{opacity:0}
    35%{opacity:.95}
    100%{opacity:0}
  }

  .win{ width:min(520px, 92vw); }
  .titlebar{
    height:28px;
    display:flex; align-items:center; gap:8px;
    padding:0 8px;
    color:#fff; font-weight:700;
    background: linear-gradient(90deg, var(--title1), var(--title2));
  }
  .tb-icon{
    width:16px;height:16px;
    border:1px solid rgba(0,0,0,.35);
    background: linear-gradient(135deg,#ff59c7,#39f2ff,#59ffc7);
  }
  .tb-spacer{flex:1}
  .tb-btn{
    width:18px;height:18px;
    display:grid; place-items:center;
    color:#000;
    background: var(--win);
    border-top: var(--frame) solid var(--hi);
    border-left: var(--frame) solid var(--hi);
    border-right: var(--frame) solid var(--dk);
    border-bottom: var(--frame) solid var(--dk);
    font-size:12px;
  }

  .start-body{ padding:10px; }
  .start-btn{
    width:100%;
    height:54px;
    display:flex; align-items:center; justify-content:center;
    gap:14px;
    font-size:40px;
    font-weight:800;
    cursor:pointer;
    background: var(--win);
    border-top: var(--frame) solid var(--hi);
    border-left: var(--frame) solid var(--hi);
    border-right: var(--frame) solid var(--dk);
    border-bottom: var(--frame) solid var(--dk);
  }
  .start-btn:active{
    border-top: var(--frame) solid var(--dk);
    border-left: var(--frame) solid var(--dk);
    border-right: var(--frame) solid var(--hi);
    border-bottom: var(--frame) solid var(--hi);
  }
  .start-flag{
    width:34px;height:34px;
    display:grid; place-items:center;
    border:1px solid rgba(0,0,0,.25);
    background:#eaeaea;
    font-weight:900;
  }
  .start-flag::before{ content:"â–¦"; }

  .app{ width:min(620px, 92vw); }
  .app-top{
    display:flex; align-items:center; gap:10px;
    padding:6px;
  }
  .navbtn, .gearbtn{
    width:42px;height:30px;
    display:grid; place-items:center;
    background: var(--win);
    border-top: var(--frame) solid var(--hi);
    border-left: var(--frame) solid var(--hi);
    border-right: var(--frame) solid var(--dk);
    border-bottom: var(--frame) solid var(--dk);
    cursor:pointer;
    font-size:18px;
  }
  .app-title{
    flex:1;
    display:flex; align-items:center; gap:10px;
    height:30px; padding:0 8px;
    background: linear-gradient(90deg, var(--title1), var(--title2));
    color:#fff; font-weight:800;
    border-top: var(--frame) solid var(--hi);
    border-left: var(--frame) solid var(--hi);
    border-right: var(--frame) solid var(--dk);
    border-bottom: var(--frame) solid var(--dk);
  }

  .hero{
    margin:6px;
    height:190px;
    position:relative;
    overflow:hidden;
    background: linear-gradient(135deg,#ff62c9,#8a7dff,#38f2ff);
  }

  .tabs{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    margin:6px;
  }
  .tab{
    height:44px;
    display:grid; place-items:center;
    font-weight:800;
    background: var(--win);
    border-top: var(--frame) solid var(--hi);
    border-left: var(--frame) solid var(--hi);
    border-right: var(--frame) solid var(--dk);
    border-bottom: var(--frame) solid var(--dk);
  }

  .panel{ margin:6px; padding:10px; }
  .panel-title{ font-weight:700; color:#4b4b4b; margin-bottom:8px; }

  .bigbtn{
    width:100%;
    height:54px;
    display:flex; align-items:center; justify-content:center;
    gap:12px;
    font-size:18px;
    font-weight:900;
    cursor:pointer;
    background: var(--win);
    border-top: var(--frame) solid var(--hi);
    border-left: var(--frame) solid var(--hi);
    border-right: var(--frame) solid var(--dk);
    border-bottom: var(--frame) solid var(--dk);
    margin:10px 0;
  }
  .bigbtn:active{
    border-top: var(--frame) solid var(--dk);
    border-left: var(--frame) solid var(--dk);
    border-right: var(--frame) solid var(--hi);
    border-bottom: var(--frame) solid var(--hi);
  }

  .footer{
    margin:6px;
    padding:8px 10px;
    font-size:13px;
    color:#4b4b4b;
    display:flex;
    justify-content:space-between;
    gap:10px;
  }
  .footer a{ color:#000; text-decoration:underline; font-weight:700; }

  /* camera modal */
  .modalWrap{
    position:fixed; inset:0;
    display:none;
    place-items:center;
    background: rgba(0,0,0,.55);
    z-index:999;
  }
  .modalWrap.show{ display:grid; }
  .modal{
    width:min(620px, 92vw);
  }
  .modal-body{ padding:10px; }
  .camRow{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
  }
  video, canvas{
    width:100%;
    height:auto;
    background:#000;
    display:block;
  }
  .actions{
    display:flex;
    justify-content:flex-end;
    gap:8px;
    margin-top:10px;
  }
  .btn{
    min-width: 92px;
    padding:6px 10px;
    background: var(--win);
    border-top: var(--frame) solid var(--hi);
    border-left: var(--frame) solid var(--hi);
    border-right: var(--frame) solid var(--dk);
    border-bottom: var(--frame) solid var(--dk);
    cursor:pointer;
    font-weight:700;
  }
  .btn:active{
    border-top: var(--frame) solid var(--dk);
    border-left: var(--frame) solid var(--dk);
    border-right: var(--frame) solid var(--hi);
    border-bottom: var(--frame) solid var(--hi);
  }

  .hint{
    font-size:12px;
    color:#333;
    margin-top:6px;
  }
</style>
</head>
<body>
  <div class="bg" id="bg"></div>
  <div class="fx"></div>
  <div class="transition" id="transition"></div>

  <div class="stage">
    <!-- START -->
    <section class="screen active" id="screenStart">
      <div class="win bevel-out" role="dialog" aria-label="Vaporgram start">
        <div class="titlebar">
          <div class="tb-icon" aria-hidden="true"></div>
          <div>VAPORGRAM V6.4.7</div>
          <div class="tb-spacer"></div>
          <div class="tb-btn" aria-hidden="true">Ã—</div>
        </div>
        <div class="start-body">
          <button class="start-btn" id="btnStart" type="button">
            <span class="start-flag" aria-hidden="true"></span>
            <span>Start</span>
          </button>
        </div>
      </div>
    </section>

    <!-- APP -->
    <section class="screen" id="screenApp">
      <div class="app bevel-out" role="application" aria-label="Vaporgram app">
        <div class="app-top">
          <button class="navbtn" id="btnBack" type="button" aria-label="Back">â€¹</button>
          <div class="app-title">
            <div class="tb-icon" aria-hidden="true"></div>
            <div>VAPORGRAM</div>
          </div>
          <button class="gearbtn" type="button" aria-label="Settings">âš™</button>
        </div>

        <div class="hero bevel-in"></div>

        <div class="tabs">
          <div class="tab">ðŸ–¼</div>
          <div class="tab" style="opacity:.65;">â–¶</div>
          <div class="tab">GIF</div>
          <div class="tab" style="opacity:.75;">ðŸ‘¤</div>
        </div>

        <div class="panel bevel-in">
          <div class="panel-title">â€¢ Edit your image</div>

          <button class="bigbtn" id="btnGallery" type="button">OPEN GALLERY</button>
          <button class="bigbtn" id="btnCamera" type="button">OPEN CAMERA</button>

          <div class="hint">
            OPEN CAMERA â†’ vyfotÃ­Å¡ â†’ udÄ›lÃ¡ se low-res pixel glitch wallpaper a uloÅ¾Ã­ se.
          </div>
        </div>

        <div class="footer bevel-in">
          <div>â€¢ Using this app you agree to the <a href="#" onclick="return false;">terms of use argument</a></div>
          <div style="width:22px;height:22px;background:repeating-linear-gradient(135deg,rgba(0,0,0,.18) 0 2px, transparent 2px 5px);"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- CAMERA MODAL -->
  <div class="modalWrap" id="modalWrap" aria-hidden="true">
    <div class="modal bevel-out" role="dialog" aria-label="Camera">
      <div class="titlebar">
        <div class="tb-icon" aria-hidden="true"></div>
        <div>CAMERA CAPTURE</div>
        <div class="tb-spacer"></div>
        <div class="tb-btn" id="btnCloseModal" title="Close">Ã—</div>
      </div>
      <div class="modal-body">
        <div class="camRow">
          <div class="bevel-in">
            <video id="video" playsinline autoplay muted></video>
          </div>
          <canvas id="canvas" style="display:none;"></canvas>
        </div>
        <div class="actions">
          <button class="btn" id="btnSnap" type="button">CAPTURE</button>
          <button class="btn" id="btnUse" type="button" disabled>USE AS BG</button>
          <button class="btn" id="btnCancel" type="button">CANCEL</button>
        </div>
        <div class="hint">
          Pokud se kamera neotevÅ™e: musÃ­Å¡ to spouÅ¡tÄ›t pÅ™es HTTPS nebo localhost (ne file://).
        </div>
      </div>
    </div>
  </div>

<script>
  const bg = document.getElementById("bg");
  const saved = localStorage.getItem("vaporgram-bg");
  if(saved){
    document.documentElement.style.setProperty("--bg-saved", `url(${saved})`);
  }

  // screen nav
  const transition = document.getElementById("transition");
  const screenStart = document.getElementById("screenStart");
  const screenApp = document.getElementById("screenApp");
  document.getElementById("btnStart").addEventListener("click", () => go(true));
  document.getElementById("btnBack").addEventListener("click", () => go(false));

  function go(toApp){
    transition.classList.remove("on");
    void transition.offsetWidth;
    transition.classList.add("on");
    setTimeout(() => {
      if(toApp){
        screenStart.classList.remove("active");
        screenApp.classList.add("active");
      }else{
        screenApp.classList.remove("active");
        screenStart.classList.add("active");
      }
    }, 110);
  }

  // modal + camera
  const modalWrap = document.getElementById("modalWrap");
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const btnCamera = document.getElementById("btnCamera");
  const btnCloseModal = document.getElementById("btnCloseModal");
  const btnCancel = document.getElementById("btnCancel");
  const btnSnap = document.getElementById("btnSnap");
  const btnUse = document.getElementById("btnUse");

  let stream = null;
  let lastShotDataUrl = null;

  btnCamera.addEventListener("click", openCamera);
  btnCloseModal.addEventListener("click", closeCamera);
  btnCancel.addEventListener("click", closeCamera);

  async function openCamera(){
    modalWrap.classList.add("show");
    modalWrap.setAttribute("aria-hidden","false");
    btnUse.disabled = true;
    lastShotDataUrl = null;
    canvas.style.display = "none";
    video.style.display = "block";

    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } },
        audio: false
      });
      video.srcObject = stream;
    }catch(err){
      alert("Kamera nejde otevÅ™Ã­t. Tip: HTTPS/localhost a povolit oprÃ¡vnÄ›nÃ­.\n\n" + err);
      closeCamera();
    }
  }

  function closeCamera(){
    modalWrap.classList.remove("show");
    modalWrap.setAttribute("aria-hidden","true");
    stopStream();
  }

  function stopStream(){
    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
  }

  btnSnap.addEventListener("click", () => {
    if(!video.videoWidth) return;

    // 1) snÃ­mek z videa do canvas
    const w = video.videoWidth;
    const h = video.videoHeight;

    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d", { willReadFrequently: true });
    ctx.drawImage(video, 0, 0, w, h);

    // 2) udÄ›lej z toho "low 90s pixel glitch"
    const out = makePixelGlitch(canvas, {
      pixelW: 140,      // ÄÃ­m menÅ¡Ã­, tÃ­m vÃ­c low
      stripes: 14,      // poÄet glitch pruhÅ¯
      rgbShift: 2,      // posun kanÃ¡lÅ¯ v px
      noise: 0.06       // Å¡um (0..0.2)
    });

    lastShotDataUrl = out.toDataURL("image/jpeg", 0.88);

    // preview: zobraz canvas mÃ­sto videa
    canvas.style.display = "block";
    video.style.display = "none";
    btnUse.disabled = false;
  });

  btnUse.addEventListener("click", () => {
    if(!lastShotDataUrl) return;

    // uloÅ¾it a nastavit jako background
    localStorage.setItem("vaporgram-bg", lastShotDataUrl);
    document.documentElement.style.setProperty("--bg-saved", `url(${lastShotDataUrl})`);

    closeCamera();
  });

  // ------- pixel + glitch pipeline -------
  function makePixelGlitch(srcCanvas, opt){
    const { pixelW, stripes, rgbShift, noise } = opt;

    const srcW = srcCanvas.width;
    const srcH = srcCanvas.height;

    // pixelate: downscale â†’ upscale
    const smallW = Math.max(48, pixelW|0);
    const smallH = Math.max(48, Math.round(srcH * (smallW / srcW)));

    const small = document.createElement("canvas");
    small.width = smallW;
    small.height = smallH;

    const sctx = small.getContext("2d", { willReadFrequently: true });
    sctx.imageSmoothingEnabled = false;
    sctx.drawImage(srcCanvas, 0, 0, smallW, smallH);

    const out = document.createElement("canvas");
    out.width = srcW;
    out.height = srcH;

    const octx = out.getContext("2d", { willReadFrequently: true });
    octx.imageSmoothingEnabled = false;
    octx.drawImage(small, 0, 0, srcW, srcH);

    // get pixels
    let img = octx.getImageData(0,0,srcW,srcH);
    let data = img.data;

    // RGB split (cheap): shift R and B slightly
    if(rgbShift > 0){
      const copy = new Uint8ClampedArray(data);
      const shift = rgbShift|0;
      for(let y=0;y<srcH;y++){
        for(let x=0;x<srcW;x++){
          const i = (y*srcW + x) * 4;

          const xr = Math.min(srcW-1, Math.max(0, x + shift));
          const xb = Math.min(srcW-1, Math.max(0, x - shift));

          const ir = (y*srcW + xr) * 4;
          const ib = (y*srcW + xb) * 4;

          data[i]   = copy[ir];     // R
          data[i+2] = copy[ib+2];   // B
        }
      }
    }

    // glitch stripes: shift random horizontal bands left/right
    for(let k=0;k<(stripes|0);k++){
      const bandH = randInt(8, 28);
      const y0 = randInt(0, srcH - bandH);
      const dx = randInt(-40, 40);

      // copy band
      const band = octx.getImageData(0, y0, srcW, bandH);
      // draw it shifted with wrap
      octx.putImageData(band, dx, y0);
      if(dx > 0){
        const wrap = octx.getImageData(srcW - dx, y0, dx, bandH);
        octx.putImageData(wrap, 0, y0);
      }else if(dx < 0){
        const wdx = -dx;
        const wrap = octx.getImageData(0, y0, wdx, bandH);
        octx.putImageData(wrap, srcW - wdx, y0);
      }
    }

    // re-grab after stripes (because we used putImageData)
    img = octx.getImageData(0,0,srcW,srcH);
    data = img.data;

    // noise + slight posterize
    for(let i=0;i<data.length;i+=4){
      const n = (Math.random()*2-1) * 255 * (noise||0);
      // posterize to 90s vibe
      data[i]   = clamp((data[i]   + n) & 0xF8); // R
      data[i+1] = clamp((data[i+1] + n) & 0xF8); // G
      data[i+2] = clamp((data[i+2] + n) & 0xF8); // B
      // alpha keep
    }

    octx.putImageData(img,0,0);

    // add a light vapor overlay (pink/cyan)
    octx.globalCompositeOperation = "screen";
    octx.fillStyle = "rgba(255,89,199,0.10)";
    octx.fillRect(0,0,srcW,srcH);
    octx.fillStyle = "rgba(57,242,255,0.08)";
    octx.fillRect(0,0,srcW,srcH);
    octx.globalCompositeOperation = "source-over";

    return out;
  }

  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function clamp(v){ return Math.max(0, Math.min(255, v)); }
</script>
</body>
</html>
